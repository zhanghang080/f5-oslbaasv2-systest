
- set_fact:
    test_casename: "ftp test"
    test_listener_protocol: FTP
    test_pool_protocol: TCP
    test_listener_tcpport: 21
    test_healthmonitor_protocol: PING

- import_tasks: ../../playbooks/task-define-resources.yml

- import_tasks: ../../playbooks/task-create-resources.yml

- import_tasks: ../../playbooks/task-get-resourceids.yml

- name: set up b64credential
  shell: b64credential=`echo -n admin:{{ hostvars[groups.bigips[0]].admin_password }} | base64` && echo $b64credential
  register: shell_b64credential

- name: set up full path 
  shell: full_path=~{{ environment_prefix }}_{{ project_id }}~ftp_profile_{{ listener_id }} && echo $full_path
  register: shell_fullpath

- set_fact:
    b64credential: "{{shell_b64credential.stdout}}"
    fullpath: "{{shell_fullpath.stdout}}"

- name: get infor from bigips
  uri:
    url: https://{{ groups.bigips[0] }}/mgmt/tm/ltm/profile/ftp/{{fullpath}}
    headers:
      Content-Type: application/json
      Authorization: "Basic {{b64credential}}"
    validate_certs: False
  register: bigip_infos

- name: assert ftp is created and associated
  assert:
    that:
      - "{{ bigip_infos.json.port }} == {{ test_listener_tcpport - 1 }}"
    quiet: yes

- import_tasks: ../../playbooks/task-remove-resources.yml